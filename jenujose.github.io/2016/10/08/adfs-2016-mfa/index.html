<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="en-us">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="ADFS 2016 changes the way Multi-Factor Authentication (MFA) is&amp;nbsp; configured and used. With previous versions of ADFS, MFA Server was downloaded and the ADFS adapter installed to provide MFA for us">
<meta name="keywords">
<meta property="og:type" content="article">
<meta property="og:title" content="ADFS 2016: MFA">
<meta property="og:url" content="https://jenujose.github.io/2016/10/08/adfs-2016-mfa/index.html">
<meta property="og:site_name" content="Notes from the field...">
<meta property="og:description" content="ADFS 2016 changes the way Multi-Factor Authentication (MFA) is&amp;nbsp; configured and used. With previous versions of ADFS, MFA Server was downloaded and the ADFS adapter installed to provide MFA for us">
<meta property="og:image" content="http://blog.jenujose.com/wp-content/uploads/2016/10/image_thumb.png">
<meta property="og:image" content="http://blog.jenujose.com/wp-content/uploads/2016/10/image_thumb1.png">
<meta property="og:image" content="http://blog.jenujose.com/wp-content/uploads/2016/10/2016-10-08_13h06_13_thumb.png">
<meta property="og:image" content="http://blog.jenujose.com/wp-content/uploads/2016/10/image4_thumb.png">
<meta property="og:image" content="http://blog.jenujose.com/wp-content/uploads/2016/10/image7_thumb.png">
<meta property="og:image" content="http://blog.jenujose.com/wp-content/uploads/2016/10/image13_thumb.png">
<meta property="og:image" content="http://blog.jenujose.com/wp-content/uploads/2016/10/image16_thumb.png">
<meta property="og:updated_time" content="2017-04-04T11:36:29.331Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ADFS 2016: MFA">
<meta name="twitter:description" content="ADFS 2016 changes the way Multi-Factor Authentication (MFA) is&amp;nbsp; configured and used. With previous versions of ADFS, MFA Server was downloaded and the ADFS adapter installed to provide MFA for us">
<meta name="twitter:image" content="http://blog.jenujose.com/wp-content/uploads/2016/10/image_thumb.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://jenujose.github.io/2016/10/08/adfs-2016-mfa/"/>





  <title>ADFS 2016: MFA | Notes from the field...</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en-us">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Notes from the field...</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://jenujose.github.io/2016/10/08/adfs-2016-mfa/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jenu Jose">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Notes from the field...">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">ADFS 2016: MFA</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-10-08T18:20:30-05:00">
                2016-10-08
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ADFS/" itemprop="url" rel="index">
                    <span itemprop="name">ADFS</span>
                  </a>
                </span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ADFS/Windows-Server/" itemprop="url" rel="index">
                    <span itemprop="name">Windows Server</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/10/08/adfs-2016-mfa/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2016/10/08/adfs-2016-mfa/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>ADFS 2016 changes the way Multi-Factor Authentication (MFA) is&nbsp; configured and used. With previous versions of ADFS, MFA Server was downloaded and the ADFS adapter installed to provide MFA for users and applications. With Windows Server 2016, the architecture has changed so that ADFS 2016 is integrated with Azure MFA. This means that the IT admin does not need to install any special software or adapter to get MFA working. In addition, MFA now can be used as a primary method of authentication—users don’t need to enter in their password to get access to resources, they can verify their identity using their phone (call, text) or by using the Microsoft Authenticator app.</p>
<p>Before ADFS 2016 MFA can be used, MFA servers need to be registered on your Azure AD tenant: This following needs to be done for each ADFS server in the farm. There is good documentation on how to get this done here: <a href="https://technet.microsoft.com/en-us/windows-server-docs/identity/ad-fs/operations/configure-ad-fs-2016-and-azure-mfa" title="https://technet.microsoft.com/en-us/windows-server-docs/identity/ad-fs/operations/configure-ad-fs-2016-and-azure-mfa" target="_blank" rel="external">https://technet.microsoft.com/en-us/windows-server-docs/identity/ad-fs/operations/configure-ad-fs-2016-and-azure-mfa</a></p>
<p><strong><span style="text-decoration: underline">Background</span></strong></p>
<p>In my lab environment, I installed ADFS 2016 and used the Export and Import scripts available in the Windows Server 2016 media to move over the settings from my 2012 R2 server. The scripts are located in the Support\ADFS folder of the OS media. The biggest key to making this work is to make sure you use the same service account.</p>
<p>FYI:You can easily add ADFS 2016 server into an existing 2012 farm seamlessly but I did not choose to go that route.</p>
<p><span style="text-decoration: underline"><strong>Configuration</strong></span></p>
<p>A certificate needs to be generated on the ADFS server which will be used for authentication against Azure AD.</p>
<p><a href="http://blog.jenujose.com/wp-content/uploads/2016/10/image.png" target="_blank" rel="external"><img src="http://blog.jenujose.com/wp-content/uploads/2016/10/image_thumb.png" alt="image" title="image"></a></p>
<p>After a certificate is generated, a new service principal needs to created and the certificate information associated with the service principal. This allows the ADFS servers to authenticate/communicate with the Azure MFA client successfully.</p>
<p>When executing the command to create the service principal ID, you are met with an error saying the end date is an invalid parameter. This seems to be a bug and I was able to get around this by omitting the start and end date altogether.</p>
<p><a href="http://blog.jenujose.com/wp-content/uploads/2016/10/image1.png" target="_blank" rel="external"><img src="http://blog.jenujose.com/wp-content/uploads/2016/10/image_thumb1.png" alt="image" title="image"></a></p>
<p>Now that I have MFA service registered with Azure AD, I can go ahead and enable MFA as an authentication method.&nbsp; MFA can be used&nbsp; the primary method of authentication or secondary. Using MFA as a primary method of authentication is great news—this means you don’t have to use your password when logging on to company resources</p>
<p>For my test environment, I’ve setup ADFS with the following configuration:</p>
<p><a href="http://blog.jenujose.com/wp-content/uploads/2016/10/2016-10-08_13h06_13.png" target="_blank" rel="external"><img src="http://blog.jenujose.com/wp-content/uploads/2016/10/2016-10-08_13h06_13_thumb.png" alt="2016-10-08_13h06_13" title="2016-10-08_13h06_13"></a></p>
<p>One of the prerequisites to get Azure MFA to work on-premise is that the “proof-up” or the setup of MFA information needs to happen in Azure AD. This means that multi-factor authentication needs to be enabled for the user. I’ve raised this issue with MS because essentially to use ADFS based Azure MFA you need to turn on Azure AD MFA (more on this later)</p>
<p>Since we’ve enabled both ADFS based Azure MFA and Azure AD MFA, we need a way to prevent double&nbsp; double MFA prompts (one from Azure and one from ADFS). You will need to change your domain federation settings to the following:</p>
<p>Set-MsolDomainFederationSettings –DomainName domainname.com -SupportsMFA $false</p>
<p>In addition, you will need to pass the MFA claim from ADFS to Azure AD so it will understand that you have already successfully authenticated via MFA on-premises. This should be added to the Office 365 Relying Party Trust (which is service I’m testing against)</p>
<p>(=&gt; issue(Type = “<a href="http://schemas.microsoft.com/claims/authnmethodsreferences" target="_blank" rel="external">http://schemas.microsoft.com/claims/authnmethodsreferences</a>“, Value = “<a href="http://schemas.microsoft.com/claims/multipleauthn" target="_blank" rel="external">http://schemas.microsoft.com/claims/multipleauthn</a>“);) </p>
<p>**After raising the proof-up question with MS they recommended to use the following for these scenarios:</p>
<p>1) Authenticating to Internal Applications – Internal applications will be able to leverage ADFS based Azure MFA for authentication. This assumes that the user has setup alternate authentication methods in Azure AD. You can send the user the link to set up MFA methods or if they use Office 365 or Microsoft cloud services, they will be forced to go through this setup.</p>
<p>2) Authenticating to Azure AD Applications – For Azure AD applications, Azure AD MFA will provide authentication. This is of course assuming Azure MFA is turned on for the user.</p>
<p>From testing, I was able to use ADFS based MFA for both scenarios and get it to work.&nbsp; It worked because I went through the initial proof-up setup (Turning on MFA in Azure AD or Setting up alternate authentication methods by going to myapps.microsoft.com)</p>
<p><span style="text-decoration: underline"><strong>User Experience</strong></span></p>
<p>When a user logs in for the first time to Office 365, they will be met with a prompt to setup MFA (I’ve set the SupportsMFA parameter to false and enabled MFA for the user in Azure AD)</p>
<p><a href="http://blog.jenujose.com/wp-content/uploads/2016/10/image41.png" target="_blank" rel="external"><img src="http://blog.jenujose.com/wp-content/uploads/2016/10/image4_thumb.png" alt="image" title="image"></a>.</p>
<p><a href="http://blog.jenujose.com/wp-content/uploads/2016/10/image71.png" target="_blank" rel="external"><img src="http://blog.jenujose.com/wp-content/uploads/2016/10/image7_thumb.png" alt="image" title="image"></a></p>
<p>I configured MFA for&nbsp; my test account to use mobile app notifications. Once you click on “Set up” you will receive a QR code which you can scan using the Microsoft Authenticator app (Work Account). Now when I login to Office 365, I’m redirected to my ADFS server and you will notice an option at the bottom for MFA Authentication:</p>
<p><a href="http://blog.jenujose.com/wp-content/uploads/2016/10/image13.png" target="_blank" rel="external"><img src="http://blog.jenujose.com/wp-content/uploads/2016/10/image13_thumb.png" alt="image" title="image"></a></p>
<p>Once you click on Azure Multi-Factor Authentication, you will have to then use the verification code from the Microsoft Authenticator app to authenticate yourself to Office 365.</p>
<p><a href="http://blog.jenujose.com/wp-content/uploads/2016/10/image16.png" target="_blank" rel="external"><img src="http://blog.jenujose.com/wp-content/uploads/2016/10/image16_thumb.png" alt="image" title="image"></a></p>
<p><span style="text-decoration: underline"><strong>Recommendations/Thoughts</strong>:</span></p>
<ol>
<li>MFA as a primary method of authentication helps prevent the use of passwords thereby reducing the chance that the password gets stolen &amp; it improves the experience of users that are trying to login with mobile devices where there’s not much real estate on the keyboard to type in a complex password.  </li><li>I suspect more documentation on this topic will be published before Windows Server 2016 is available to corporate customers which might explain some of the caveats I’ve run into.  </li><li>The integration of the cloud services such as the MFA service with the Server OS is a great way to unify the setup and configuration process regardless of if you are hybrid or cloud organization.</li>
</ol>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/10/13/adfs-2016-conditional-access-device-claims/" rel="next" title="ADFS, Device Claims & Conditional Access">
                <i class="fa fa-chevron-left"></i> ADFS, Device Claims & Conditional Access
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2016/09/30/microsoft-intune-per-app-vpn-for-android/" rel="prev" title="Microsoft Intune Per-App VPN for Android">
                Microsoft Intune Per-App VPN for Android <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Jenu Jose</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">8</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">8</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">3</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          <div class="links-of-author motion-element">
            
              
                <span class="links-of-author-item">
                  <a href="mailto:yourname@gmail.com" target="_blank" title="E-Mail">
                    
                      <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://twitter.com/jenu" target="_blank" title="Twitter">
                    
                      <i class="fa fa-fw fa-twitter"></i>Twitter</a>
                </span>
              
            
          </div>

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jenu Jose</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.3</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.3"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  

    
      <script id="dsq-count-scr" src="https://.disqus.com/count.js" async></script>
    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'https://jenujose.github.io/2016/10/08/adfs-2016-mfa/';
          this.page.identifier = '2016/10/08/adfs-2016-mfa/';
          this.page.title = 'ADFS 2016: MFA';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
