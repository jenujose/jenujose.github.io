<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-138306519-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


  
  <title>ADFS 2016: MFA | Cloud &amp; Security Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="ADFS 2016 changes the way Multi-Factor Authentication (MFA) is&amp;nbsp; configured and used. With previous versions of ADFS, MFA Server was downloaded and the ADFS adapter installed to provide MFA for us">
<meta property="og:type" content="article">
<meta property="og:title" content="ADFS 2016: MFA">
<meta property="og:url" content="https://jenujose.github.io/2016/10/08/adfs-2016-mfa/index.html">
<meta property="og:site_name" content="Cloud &amp; Security Blog">
<meta property="og:description" content="ADFS 2016 changes the way Multi-Factor Authentication (MFA) is&amp;nbsp; configured and used. With previous versions of ADFS, MFA Server was downloaded and the ADFS adapter installed to provide MFA for us">
<meta property="og:locale" content="default">
<meta property="og:image" content="http://blog.jenujose.com/wp-content/uploads/2016/10/image_thumb.png">
<meta property="og:image" content="http://blog.jenujose.com/wp-content/uploads/2016/10/image_thumb1.png">
<meta property="og:image" content="http://blog.jenujose.com/wp-content/uploads/2016/10/2016-10-08_13h06_13_thumb.png">
<meta property="og:image" content="http://blog.jenujose.com/wp-content/uploads/2016/10/image4_thumb.png">
<meta property="og:image" content="http://blog.jenujose.com/wp-content/uploads/2016/10/image7_thumb.png">
<meta property="og:image" content="http://blog.jenujose.com/wp-content/uploads/2016/10/image13_thumb.png">
<meta property="og:image" content="http://blog.jenujose.com/wp-content/uploads/2016/10/image16_thumb.png">
<meta property="og:updated_time" content="2017-04-04T11:36:29.332Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ADFS 2016: MFA">
<meta name="twitter:description" content="ADFS 2016 changes the way Multi-Factor Authentication (MFA) is&amp;nbsp; configured and used. With previous versions of ADFS, MFA Server was downloaded and the ADFS adapter installed to provide MFA for us">
<meta name="twitter:image" content="http://blog.jenujose.com/wp-content/uploads/2016/10/image_thumb.png">
<meta name="twitter:creator" content="@jenu">
  
    <link rel="alternate" href="/atom.xml" title="Cloud &amp; Security Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Cloud &amp; Security Blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://jenujose.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-adfs-2016-mfa" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/10/08/adfs-2016-mfa/" class="article-date">
  <time datetime="2016-10-08T23:20:30.000Z" itemprop="datePublished">2016-10-08</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/ADFS/">ADFS</a>►<a class="article-category-link" href="/categories/ADFS/Windows-Server/">Windows Server</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      ADFS 2016: MFA
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>ADFS 2016 changes the way Multi-Factor Authentication (MFA) is&nbsp; configured and used. With previous versions of ADFS, MFA Server was downloaded and the ADFS adapter installed to provide MFA for users and applications. With Windows Server 2016, the architecture has changed so that ADFS 2016 is integrated with Azure MFA. This means that the IT admin does not need to install any special software or adapter to get MFA working. In addition, MFA now can be used as a primary method of authentication—users don’t need to enter in their password to get access to resources, they can verify their identity using their phone (call, text) or by using the Microsoft Authenticator app.</p>
<p>Before ADFS 2016 MFA can be used, MFA servers need to be registered on your Azure AD tenant: This following needs to be done for each ADFS server in the farm. There is good documentation on how to get this done here: <a href="https://technet.microsoft.com/en-us/windows-server-docs/identity/ad-fs/operations/configure-ad-fs-2016-and-azure-mfa" title="https://technet.microsoft.com/en-us/windows-server-docs/identity/ad-fs/operations/configure-ad-fs-2016-and-azure-mfa" target="_blank" rel="noopener">https://technet.microsoft.com/en-us/windows-server-docs/identity/ad-fs/operations/configure-ad-fs-2016-and-azure-mfa</a></p>
<p><strong><span style="text-decoration: underline">Background</span></strong></p>
<p>In my lab environment, I installed ADFS 2016 and used the Export and Import scripts available in the Windows Server 2016 media to move over the settings from my 2012 R2 server. The scripts are located in the Support\ADFS folder of the OS media. The biggest key to making this work is to make sure you use the same service account.</p>
<p>FYI:You can easily add ADFS 2016 server into an existing 2012 farm seamlessly but I did not choose to go that route.</p>
<p><span style="text-decoration: underline"><strong>Configuration</strong></span></p>
<p>A certificate needs to be generated on the ADFS server which will be used for authentication against Azure AD.</p>
<p><a href="http://blog.jenujose.com/wp-content/uploads/2016/10/image.png" target="_blank" rel="noopener"><img src="http://blog.jenujose.com/wp-content/uploads/2016/10/image_thumb.png" alt="image" title="image"></a></p>
<p>After a certificate is generated, a new service principal needs to created and the certificate information associated with the service principal. This allows the ADFS servers to authenticate/communicate with the Azure MFA client successfully.</p>
<p>When executing the command to create the service principal ID, you are met with an error saying the end date is an invalid parameter. This seems to be a bug and I was able to get around this by omitting the start and end date altogether.</p>
<p><a href="http://blog.jenujose.com/wp-content/uploads/2016/10/image1.png" target="_blank" rel="noopener"><img src="http://blog.jenujose.com/wp-content/uploads/2016/10/image_thumb1.png" alt="image" title="image"></a></p>
<p>Now that I have MFA service registered with Azure AD, I can go ahead and enable MFA as an authentication method.&nbsp; MFA can be used&nbsp; the primary method of authentication or secondary. Using MFA as a primary method of authentication is great news—this means you don’t have to use your password when logging on to company resources</p>
<p>For my test environment, I’ve setup ADFS with the following configuration:</p>
<p><a href="http://blog.jenujose.com/wp-content/uploads/2016/10/2016-10-08_13h06_13.png" target="_blank" rel="noopener"><img src="http://blog.jenujose.com/wp-content/uploads/2016/10/2016-10-08_13h06_13_thumb.png" alt="2016-10-08_13h06_13" title="2016-10-08_13h06_13"></a></p>
<p>One of the prerequisites to get Azure MFA to work on-premise is that the “proof-up” or the setup of MFA information needs to happen in Azure AD. This means that multi-factor authentication needs to be enabled for the user. I’ve raised this issue with MS because essentially to use ADFS based Azure MFA you need to turn on Azure AD MFA (more on this later)</p>
<p>Since we’ve enabled both ADFS based Azure MFA and Azure AD MFA, we need a way to prevent double&nbsp; double MFA prompts (one from Azure and one from ADFS). You will need to change your domain federation settings to the following:</p>
<p>Set-MsolDomainFederationSettings –DomainName domainname.com -SupportsMFA $false</p>
<p>In addition, you will need to pass the MFA claim from ADFS to Azure AD so it will understand that you have already successfully authenticated via MFA on-premises. This should be added to the Office 365 Relying Party Trust (which is service I’m testing against)</p>
<p>(=&gt; issue(Type = “<a href="http://schemas.microsoft.com/claims/authnmethodsreferences" target="_blank" rel="noopener">http://schemas.microsoft.com/claims/authnmethodsreferences</a>“, Value = “<a href="http://schemas.microsoft.com/claims/multipleauthn" target="_blank" rel="noopener">http://schemas.microsoft.com/claims/multipleauthn</a>“);) </p>
<p>**After raising the proof-up question with MS they recommended to use the following for these scenarios:</p>
<p>1) Authenticating to Internal Applications – Internal applications will be able to leverage ADFS based Azure MFA for authentication. This assumes that the user has setup alternate authentication methods in Azure AD. You can send the user the link to set up MFA methods or if they use Office 365 or Microsoft cloud services, they will be forced to go through this setup.</p>
<p>2) Authenticating to Azure AD Applications – For Azure AD applications, Azure AD MFA will provide authentication. This is of course assuming Azure MFA is turned on for the user.</p>
<p>From testing, I was able to use ADFS based MFA for both scenarios and get it to work.&nbsp; It worked because I went through the initial proof-up setup (Turning on MFA in Azure AD or Setting up alternate authentication methods by going to myapps.microsoft.com)</p>
<p><span style="text-decoration: underline"><strong>User Experience</strong></span></p>
<p>When a user logs in for the first time to Office 365, they will be met with a prompt to setup MFA (I’ve set the SupportsMFA parameter to false and enabled MFA for the user in Azure AD)</p>
<p><a href="http://blog.jenujose.com/wp-content/uploads/2016/10/image41.png" target="_blank" rel="noopener"><img src="http://blog.jenujose.com/wp-content/uploads/2016/10/image4_thumb.png" alt="image" title="image"></a>.</p>
<p><a href="http://blog.jenujose.com/wp-content/uploads/2016/10/image71.png" target="_blank" rel="noopener"><img src="http://blog.jenujose.com/wp-content/uploads/2016/10/image7_thumb.png" alt="image" title="image"></a></p>
<p>I configured MFA for&nbsp; my test account to use mobile app notifications. Once you click on “Set up” you will receive a QR code which you can scan using the Microsoft Authenticator app (Work Account). Now when I login to Office 365, I’m redirected to my ADFS server and you will notice an option at the bottom for MFA Authentication:</p>
<p><a href="http://blog.jenujose.com/wp-content/uploads/2016/10/image13.png" target="_blank" rel="noopener"><img src="http://blog.jenujose.com/wp-content/uploads/2016/10/image13_thumb.png" alt="image" title="image"></a></p>
<p>Once you click on Azure Multi-Factor Authentication, you will have to then use the verification code from the Microsoft Authenticator app to authenticate yourself to Office 365.</p>
<p><a href="http://blog.jenujose.com/wp-content/uploads/2016/10/image16.png" target="_blank" rel="noopener"><img src="http://blog.jenujose.com/wp-content/uploads/2016/10/image16_thumb.png" alt="image" title="image"></a></p>
<p><span style="text-decoration: underline"><strong>Recommendations/Thoughts</strong>:</span></p>
<ol>
<li>MFA as a primary method of authentication helps prevent the use of passwords thereby reducing the chance that the password gets stolen &amp; it improves the experience of users that are trying to login with mobile devices where there’s not much real estate on the keyboard to type in a complex password.  </li><li>I suspect more documentation on this topic will be published before Windows Server 2016 is available to corporate customers which might explain some of the caveats I’ve run into.  </li><li>The integration of the cloud services such as the MFA service with the Server OS is a great way to unify the setup and configuration process regardless of if you are hybrid or cloud organization.</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://jenujose.github.io/2016/10/08/adfs-2016-mfa/" data-id="ckiv5x9hm000cbcupqeqkvf5e" class="article-share-link">Share</a>
      
        <a href="https://jenujose.github.io/2016/10/08/adfs-2016-mfa/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2016/10/13/adfs-2016-conditional-access-device-claims/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          ADFS, Device Claims &amp; Conditional Access
        
      </div>
    </a>
  
  
    <a href="/2016/09/30/microsoft-intune-per-app-vpn-for-android/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Microsoft Intune Per-App VPN for Android</div>
    </a>
  
</nav>

  
</article>


<section id="comments">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>
</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/ADFS/">ADFS</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/ADFS/Azure/">Azure</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/ADFS/Azure/EMS/">EMS</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/ADFS/Windows-Server/">Windows Server</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Azure/">Azure</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Azure/EMS/">EMS</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/SCCM/">SCCM</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Uncategorized/">Uncategorized</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Azure-MFA/">Azure MFA</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Exchange-Online-Office-365/">Exchange Online, Office 365</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Intune-MEMCM-VPN-Mobility/">Intune, MEMCM, VPN, Mobility</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SCCM/">SCCM</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SQL/">SQL</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Azure-MFA/" style="font-size: 10px;">Azure MFA</a> <a href="/tags/Exchange-Online-Office-365/" style="font-size: 10px;">Exchange Online, Office 365</a> <a href="/tags/Intune-MEMCM-VPN-Mobility/" style="font-size: 10px;">Intune, MEMCM, VPN, Mobility</a> <a href="/tags/SCCM/" style="font-size: 10px;">SCCM</a> <a href="/tags/SQL/" style="font-size: 10px;">SQL</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">October 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">September 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">December 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/02/">February 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/01/">January 2015</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/11/09/Exploring-Microsoft-Tunnel/">Exploring Microsoft Tunnel (Part 1)</a>
          </li>
        
          <li>
            <a href="/2020/06/20/Reporting-Read-Only-Conditional-Access-Rule/">Reporting Read-Only Conditional Access Rule</a>
          </li>
        
          <li>
            <a href="/2019/04/14/Gotcha's with Azure Multi-Factor Authentication/">Azure Multi-Factor Authentication &amp; Conditional Access Policy Tips</a>
          </li>
        
          <li>
            <a href="/2017/12/22/Shared-Mailboxes-don-t-automap-to-Outlook-in-Exchange-Online/">Shared Mailboxes don&#39;t automap to Outlook in Exchange Online</a>
          </li>
        
          <li>
            <a href="/2016/10/13/adfs-2016-conditional-access-device-claims/">ADFS, Device Claims &amp; Conditional Access</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 Jenu Jose<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    
<script>
  var disqus_shortname = 'blog-jenujose-com';
  
  var disqus_url = 'https://jenujose.github.io/2016/10/08/adfs-2016-mfa/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>